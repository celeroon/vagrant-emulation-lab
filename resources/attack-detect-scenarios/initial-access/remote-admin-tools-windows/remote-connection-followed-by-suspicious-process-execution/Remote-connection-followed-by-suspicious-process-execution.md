# Remote connection followed by suspicious process execution

In your scenario, when a threat actor gained access to the router application container (the Linux inside), they discovered the network via scanning and found some Windows hosts that could potentially be exploited. We will skip the exploitation step - assume something was found, and instead log in with the `vagrant` account and create a new one using WinRM.

The query used for the rule here is mostly for testing. I have a lot of fun testing ESQL queries.

Let’s look at the workflow:

1. Someone uses a tool on the remote network to create a new user and add it to a group on a Windows host (in our case via WinRM). The main processes used are `cmd.exe`, `net.exe`, and `net1.exe`.
2. After the new user is created, a new session is initiated to the host using `SSH`.
3. After accessing the host via `SSH`, a new `powershell` process is spawned followed by opening a new process - `calc.exe`.
4. The user disconnects from the host.

This scenario continues the [previous workflow](/resources/attack-detect-scenarios/reconnaissance/networkidiscovery-and-port-scanning/Suspicious-Gateway-Network-Scan/Suspicious-Gateway-Network-Scan.md), which shows an example of user account creation to illustrate what can happen on the Windows host side.

The main query for this example:

```bash
FROM logs-* METADATA _id, _index
| WHERE (
    (event.category == "network" AND network.direction == "ingress" AND source.ip NOT IN ("224.0.0.251","192.168.225.1") AND destination.port != 68)
    OR (event.category == "process" AND event.code == "1" AND process.name IN ("cmd.exe","powershell.exe","net.exe","net1.exe") OR process.parent.name IN ("cmd.exe","powershell.exe","net.exe","net1.exe"))
    OR (event.category == "iam" AND winlog.task == "User Account Management" AND event.code IN ("4724","4738","4722","4720"))
    OR (event.category == "authentication" AND event.code == "4624" AND winlog.task == "Logon" AND winlog.event_data.TargetUserName != "SYSTEM" AND winlog.logon.type != "Service")
    OR (event.category == "authentication" AND event.code == "4634" AND winlog.task == "Logoff" AND winlog.logon.type != "Service")
  )
| KEEP @timestamp, event.category, event.code, event.action,
       source.ip, destination.ip, destination.port,
       process.name, process.command_line, process.parent.name, winlog.task,
       winlog.event_data.SubjectUserName, winlog.event_data.TargetUserName,
       source.ip, destination.ip, host.id,
       _id, _index
| SORT @timestamp ASC
```

[This rule](/resources/attack-detect-scenarios/initial-access/remote-admin-tools-windows/remote-connection-followed-by-suspicious-process-execution/rules/Remote-connection-followed-by-suspicious-process-execution.ndjson) can generate many alerts.

<div align="center">
    <img alt="Security alert" src="/resources/attack-detect-scenarios/initial-access/remote-admin-tools-windows/remote-connection-followed-by-suspicious-process-execution/images/alert.png" width="100%">
</div>

```
| '@timestamp                 | event.category   | event.code   | event.action          | destination.port   | process.name     | process.command_line                                                                                                            | process.parent.name   | winlog.task                                        | winlog.event_data.SubjectUserName   | winlog.event_data.TargetUserName   | source.ip     | destination.ip   |
|:----------------------------|:-----------------|:-------------|:----------------------|:-------------------|:-----------------|:--------------------------------------------------------------------------------------------------------------------------------|:----------------------|:---------------------------------------------------|:------------------------------------|:-----------------------------------|:--------------|:-----------------|
| Oct 12, 2025 @ 15:17:04.729 | authentication   | 4634         | logged-out            | '-                 | -                | -                                                                                                                               | -                     | Logoff                                             | -                                   | testuser                           | '-            | '-               |
| Oct 12, 2025 @ 15:16:02.801 | process          | -            | end                   | '-                 | powershell.exe   | powershell                                                                                                                      | cmd.exe               | -                                                  | -                                   | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:54.892 | process          | 4688         | created-process       | '-                 | calc.exe         | -                                                                                                                               | powershell.exe        | Process Creation                                   | testuser                            | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:54.892 | process          | -            | end, start            | '-                 | calc.exe         | "C:\Windows\system32\calc.exe"                                                                                                  | powershell.exe        | -                                                  | -                                   | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:47.055 | process          | -            | start                 | '-                 | powershell.exe   | powershell                                                                                                                      | cmd.exe               | -                                                  | -                                   | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:47.055 | process          | 4688         | created-process       | '-                 | powershell.exe   | -                                                                                                                               | cmd.exe               | Process Creation                                   | testuser                            | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:47.055 | process          | 1            | Process creation      | '-                 | powershell.exe   | powershell                                                                                                                      | cmd.exe               | Process Create (rule: ProcessCreate)               | -                                   | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:44.230 | process          | 1            | Process creation      | '-                 | cmd.exe          | c:\windows\system32\cmd.exe                                                                                                     | conhost.exe           | Process Create (rule: ProcessCreate)               | -                                   | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:41.245 | authentication   | 4624         | logged-in             | '-                 | sshd-session.exe | -                                                                                                                               | -                     | Logon                                              | WIN-USER-1$                         | testuser                           | '-            | '-               |
| Oct 12, 2025 @ 15:15:37.040 | authentication   | 4624         | logged-in             | '-                 | sshd-session.exe | -                                                                                                                               | -                     | Logon                                              | WIN-USER-1$                         | sshd_14500                         | '-            | '-               |
| Oct 12, 2025 @ 15:15:35.995 | network          | 3            | Network connection    | 22                 | sshd.exe         | -                                                                                                                               | -                     | Network connection detected (rule: NetworkConnect) | -                                   | -                                  | 172.30.10.254 | 172.16.20.230    |
| Oct 12, 2025 @ 15:15:17.436 | authentication   | 4634         | logged-out            | '-                 | -                | -                                                                                                                               | -                     | Logoff                                             | -                                   | vagrant                            | '-            | '-               |
| Oct 12, 2025 @ 15:15:17.431 | authentication   | 4634         | logged-out            | '-                 | -                | -                                                                                                                               | -                     | Logoff                                             | -                                   | vagrant                            | '-            | '-               |
| Oct 12, 2025 @ 15:15:17.421 | authentication   | 4624         | logged-in             | '-                 | svchost.exe      | -                                                                                                                               | -                     | Logon                                              | WIN-USER-1$                         | vagrant                            | '-            | '-               |
| Oct 12, 2025 @ 15:15:17.378 | authentication   | 4634         | logged-out            | '-                 | -                | -                                                                                                                               | -                     | Logoff                                             | -                                   | vagrant                            | '-            | '-               |
| Oct 12, 2025 @ 15:15:17.370 | authentication   | 4624         | logged-in             | '-                 | svchost.exe      | -                                                                                                                               | -                     | Logon                                              | WIN-USER-1$                         | vagrant                            | '-            | '-               |
| Oct 12, 2025 @ 15:15:17.363 | authentication   | 4634         | logged-out            | '-                 | -                | -                                                                                                                               | -                     | Logoff                                             | -                                   | vagrant                            | '-            | '-               |
| Oct 12, 2025 @ 15:15:17.221 | process          | 1            | Process creation      | '-                 | net1.exe         | C:\WINDOWS\system32\net1  localgroup Administrators testuser /add                                                               | net.exe               | Process Create (rule: ProcessCreate)               | -                                   | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:17.221 | process          | -            | end, start            | '-                 | net1.exe         | C:\WINDOWS\system32\net1  localgroup Administrators testuser /add                                                               | net.exe               | -                                                  | -                                   | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:17.221 | process          | 4688         | created-process       | '-                 | net1.exe         | -                                                                                                                               | net.exe               | Process Creation                                   | vagrant                             | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:17.170 | process          | 1            | Process creation      | '-                 | net.exe          | net  localgroup Administrators testuser /add                                                                                    | cmd.exe               | Process Create (rule: ProcessCreate)               | -                                   | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:17.170 | process          | -            | end, start            | '-                 | net.exe          | net  localgroup Administrators testuser /add                                                                                    | cmd.exe               | -                                                  | -                                   | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:17.170 | process          | 4688         | created-process       | '-                 | net.exe          | -                                                                                                                               | cmd.exe               | Process Creation                                   | vagrant                             | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:17.106 | iam              | 4722         | enabled-user-account  | '-                 | -                | -                                                                                                                               | -                     | User Account Management                            | vagrant                             | testuser                           | '-            | '-               |
| Oct 12, 2025 @ 15:15:17.106 | iam              | 4724         | reset-password        | '-                 | -                | -                                                                                                                               | -                     | User Account Management                            | vagrant                             | testuser                           | '-            | '-               |
| Oct 12, 2025 @ 15:15:17.106 | iam              | 4738         | modified-user-account | '-                 | -                | -                                                                                                                               | -                     | User Account Management                            | vagrant                             | testuser                           | '-            | '-               |
| Oct 12, 2025 @ 15:15:17.032 | iam              | 4720         | added-user-account    | '-                 | -                | -                                                                                                                               | -                     | User Account Management                            | vagrant                             | testuser                           | '-            | '-               |
| Oct 12, 2025 @ 15:15:16.947 | process          | 4688         | created-process       | '-                 | net1.exe         | -                                                                                                                               | net.exe               | Process Creation                                   | vagrant                             | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:16.946 | process          | 1            | Process creation      | '-                 | net1.exe         | C:\WINDOWS\system32\net1  user testuser "ServicePass1!" /add                                                                    | net.exe               | Process Create (rule: ProcessCreate)               | -                                   | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:16.946 | process          | -            | end, start            | '-                 | net1.exe         | C:\WINDOWS\system32\net1  user testuser "ServicePass1!" /add                                                                    | net.exe               | -                                                  | -                                   | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:16.871 | process          | 4688         | created-process       | '-                 | net.exe          | -                                                                                                                               | cmd.exe               | Process Creation                                   | vagrant                             | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:16.871 | process          | 1            | Process creation      | '-                 | net.exe          | net  user testuser "ServicePass1!" /add                                                                                         | cmd.exe               | Process Create (rule: ProcessCreate)               | -                                   | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:16.871 | process          | -            | end, start            | '-                 | net.exe          | net  user testuser "ServicePass1!" /add                                                                                         | cmd.exe               | -                                                  | -                                   | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:16.811 | process          | 1            | Process creation      | '-                 | cmd.exe          | cmd.exe  /c net user testuser "ServicePass1!" /add                                                                              | cmd.exe               | Process Create (rule: ProcessCreate)               | -                                   | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:16.811 | process          | 4688         | created-process       | '-                 | cmd.exe          | -                                                                                                                               | cmd.exe               | Process Creation                                   | vagrant                             | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:16.811 | process          | -            | end, start            | '-                 | cmd.exe          | cmd.exe  /c net user testuser "ServicePass1!" /add                                                                              | cmd.exe               | -                                                  | -                                   | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:16.809 | authentication   | 4624         | logged-in             | '-                 | svchost.exe      | -                                                                                                                               | -                     | Logon                                              | WIN-USER-1$                         | vagrant                            | '-            | '-               |
| Oct 12, 2025 @ 15:15:16.704 | process          | 1            | Process creation      | '-                 | cmd.exe          | C:\WINDOWS\system32\cmd.exe /C cmd.exe /c net user testuser "ServicePass1!" /add && net localgroup Administrators testuser /add | winrshost.exe         | Process Create (rule: ProcessCreate)               | -                                   | -                                  | '-            | '-               |
| Oct 12, 2025 @ 15:15:16.694 | authentication   | 4624         | logged-in             | '-                 | svchost.exe      | -                                                                                                                               | -                     | Logon                                              | WIN-USER-1$                         | vagrant                            | '-            | '-               |
| Oct 12, 2025 @ 15:15:16.318 | authentication   | 4634         | logged-out            | '-                 | -                | -                                                                                                                               | -                     | Logoff                                             | -                                   | vagrant                            | '-            | '-               |
| Oct 12, 2025 @ 15:15:16.281 | authentication   | 4624         | logged-in             | '-                 | svchost.exe      | -                                                                                                                               | -                     | Logon                                              | WIN-USER-1$                         | vagrant                            | '-            | '-               |
| Oct 12, 2025 @ 15:15:15.429 | network          | 3            | Network connection    | 5,985              | -                | -                                                                                                                               | -                     | Network connection detected (rule: NetworkConnect) | -                                   | -                                  | 172.30.10.254 | 172.16.20.230    |
```

Let’s inspect the events, starting from the bottom:

1. Remote host `172.30.10.254` initiates a session to `172.16.20.230` on port `5985` (WinRM).
2. Based on the [previous example](/resources/attack-detect-scenarios/reconnaissance/networkidiscovery-and-port-scanning/Suspicious-Gateway-Network-Scan/Suspicious-Gateway-Network-Scan.md), it logs in to the host using an existing user - so event `4624` is followed by `4634` (Logoff). This creates a new session as with the Python script.
3. Using the Python script from the previous step to create a new user - spawns another `4624`, followed by the new `testuser` creation and another `4634` (Logoff).
4. A new network connection event appears with `event.code` 3 (Sysmon), but this is an `SSH` session with a new `TargetUserName` (testuser).
5. After the user gains SSH access, they initially reside in `cmd.exe`, so you can see the `powershell` process spawned with `cmd.exe` as the parent.
6. Using PowerShell, `calc.exe` is spawned.
7. The user disconnects.

Because this rule generates many alerts, it’s more convenient to use dashboards to distinguish hosts by `host.id`. You can import the [dashboard](/resources/attack-detect-scenarios/initial-access/remote-admin-tools-windows/remote-connection-followed-by-suspicious-process-execution/dashboards/dashboard-object.ndjson) into Kibana saved objects.

<div align="center">
    <img alt="Kibana dashboard" src="/resources/attack-detect-scenarios/initial-access/remote-admin-tools-windows/remote-connection-followed-by-suspicious-process-execution/images/dashboard-1.png" width="100%">
</div>

<div align="center">
    <img alt="Kibana dashboard" src="/resources/attack-detect-scenarios/initial-access/remote-admin-tools-windows/remote-connection-followed-by-suspicious-process-execution/images/dashboard-2.png" width="100%">
</div>
